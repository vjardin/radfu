name: Packages

on:
  push:
    tags: ['v*']
  workflow_dispatch:

jobs:
  deb-debian:
    name: Debian package
    runs-on: ubuntu-latest
    container: debian:bookworm
    steps:
      - uses: actions/checkout@v4
        with:
          path: radfu

      - name: Install build dependencies
        run: |
          apt-get update
          apt-get install -y build-essential debhelper meson ninja-build pkg-config libcmocka-dev

      - name: Build package
        working-directory: radfu
        run: dpkg-buildpackage -us -uc -b

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: deb-debian
          path: "*.deb"

  deb-ubuntu:
    name: Ubuntu package
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          path: radfu

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential debhelper meson ninja-build libcmocka-dev

      - name: Build package
        working-directory: radfu
        run: dpkg-buildpackage -us -uc -b

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: deb-ubuntu
          path: "*.deb"

  rpm-fedora:
    name: Fedora package
    runs-on: ubuntu-latest
    container: fedora:latest
    steps:
      - uses: actions/checkout@v4

      - name: Install build dependencies
        run: dnf install -y rpm-build meson ninja-build gcc libcmocka-devel

      - name: Create tarball
        run: |
          mkdir -p ~/rpmbuild/{SOURCES,SPECS}
          tar czf ~/rpmbuild/SOURCES/radfu-0.0.1.tar.gz --transform 's,^,radfu-0.0.1/,' *
          cp radfu.spec ~/rpmbuild/SPECS/

      - name: Build RPM
        run: rpmbuild -bb ~/rpmbuild/SPECS/radfu.spec

      - name: Copy RPM to workspace
        run: cp ~/rpmbuild/RPMS/*/*.rpm .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: rpm-fedora
          path: "*.rpm"
